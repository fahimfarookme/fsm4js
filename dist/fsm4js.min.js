"use strict";if("undefined"==typeof FSM4JS)var FSM4JS={};!function(fsm4js){fsm4js.version="0.0.1",fsm4js.fsm=function(){var parent=Object.create(fsm4js._builder.prototype);return this._builder.apply(parent,arguments)||parent}}(FSM4JS),function(fsm4js){var isValidTransition=function(event,eventArr,stateArr){return event&&fsm4js._util.isString(event.event)&&fsm4js._util.isString(event.from)&&-1!==eventArr.indexOf(event.event)&&-1!==stateArr.indexOf(event.from)},isValidState=function(state,stateArr){return fsm4js._util.isString(state)&&-1!==stateArr.indexOf(state)},isValidLifecycle=function(lifecycle){return lifecycle&&fsm4js._util.isFunction(lifecycle.enter)},builder=function(){this._initState=null,this._currentState=null,this._previousState=null,this._states=[],this._stateMap={},this._events=[],this._transitions={},this._afterExit={},this._beforeEnter={}};builder.prototype={constructor:builder,init:function(state,data){return this._initState={state:state,data:data},this},states:function(states){return 0===arguments.length?this._states:(fsm4js._util.isArray(states)&&states.length>0?this._states=this._states.concat(states):this._states.push(states),this)},current:function(){return!this._currentState&&fsm4js._util.throwError("No current state since FSM is not yet started."),this._currentState},events:function(events){return 0===arguments.length?this._events:(fsm4js._util.isArray(events)&&events.length>0?this._events=this._events.concat(events):this._events.push(events),this)},transitions:function(trns){if(0===arguments.length)return this._transitions;if(fsm4js._util.isArray(trns)&&trns.length>0)for(var i=0,len=trns.length;len>i;i++)this._addTransition(trns[i]);else this._addTransition(trns);return this},on:function(state,lifecycle){return!isValidState(state,this._states)&&fsm4js._util.throwError("Invalid state - "+state),!isValidLifecycle(lifecycle)&&fsm4js._util.throwError("Invalid lifecycle { enter, exit } - "+lifecycle),this._stateMap[state]=lifecycle,this},start:function(data,state){return state&&this.init(state),!this._initState&&fsm4js._util.throwError("No init state set."),!isValidState(this._initState.state,this._states)&&fsm4js._util.throwError("Invalid init state - ",this._initState.state),this._initState.data=data,this._exitCurrentState(),this._enterNextState(null,this._initState.state,this._initState.data),this},transitionTo:function(state,data){return!isValidState(state,this._states)&&fsm4js._util.throwError("Invalid state - "+state),this._exitCurrentState(),this._enterNextState(null,state,data),this},beforeEnter:function(fn,context){return!fsm4js._util.isFunction(fn)&&fsm4js._util.throwError("Invalid function for beforeEnter"),this._beforeEnter={fn:fn,context:context},this},afterExit:function(fn,context){return!fsm4js._util.isFunction(fn)&&fsm4js._util.throwError("Invalid function for afterExit"),this._afterExit={fn:fn,context:context},this},_addTransition:function(trns){!isValidTransition(trns,this._events,this._states)&&fsm4js._util.throwError("Invalid transition - "+trns),this._transitions[trns.from]=this._transitions[trns.from]||{},this._transitions[trns.from][trns.event]=trns.to||this._transitions[trns.from][trns.event]||{},this._createEvent(trns.event)},_createEvent:function(event){var self=this;this[event]=function(data){self._transition(event,data)}},_transition:function(event,data){this._exitCurrentState(event);var next=this._findNextState(event);next&&this._enterNextState(event,next,data)},_exitCurrentState:function(event){if(this._currentState){this._previousState={state:this._currentState.state,data:this._currentState.data};var options={from:this._previousState,event:event};this._beforeEnter.fn&&this._beforeEnter.fn.call(this._beforeEnter._context,options);var exit=fsm4js._util.safeGet(this._stateMap[this._previousState.state],"exit");exit&&exit(options)}},_findNextState:function(event){var from=this._transitions[this._previousState.state];return!from&&fsm4js._util.throwError("From state not defined - "+this._previousState.state),from[event]},_enterNextState:function(event,state,data){this._currentState={state:state,data:data};var options={from:this._previousState,event:event,to:this._currentState},enter=fsm4js._util.safeGet(this._stateMap[this._currentState.state],"enter");enter&&enter(options),this._afterExit.fn&&this._afterExit.fn.call(this._afterExit.context,options)}},fsm4js._builder=builder}(FSM4JS),function(fsm4js){fsm4js._util={throwError:function(msg){throw new Error(msg)},isArray:function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},isString:function(obj){return"string"==typeof obj},isFunction:function(obj){return"function"==typeof obj},safeGet:function(obj,prop){return obj&&obj[prop]}}}(FSM4JS);